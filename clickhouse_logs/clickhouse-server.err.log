2026.02.03 12:40:18.270352 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.03 12:40:18.274974 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.03 12:40:18.381991 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.03 12:40:18.393673 [ 1 ] {} <Warning> Access(local_directory): File /var/lib/clickhouse/access/users.list doesn't exist
2026.02.03 12:40:18.393895 [ 1 ] {} <Warning> Access(local_directory): Recovering lists in directory /var/lib/clickhouse/access/
2026.02.03 12:40:18.467080 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.03 12:40:18.484059 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.03 12:40:18.500093 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.03 12:40:18.525779 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.05 13:31:15.366247 [ 47 ] {1d207383-0483-4789-8a9f-b2658dbfb1f8} <Error> executeQuery: Code: 44. DB::Exception: Sorting key contains nullable columns, but merge tree setting `allow_nullable_key` is disabled. (ILLEGAL_COLUMN) (version 23.8.16.16 (official build)) (from 172.18.0.5:55874) (in query:  CREATE TABLE IF NOT EXISTS payments_all ( tenant_id String, loan_type String, loan_account_number String, installment_number Nullable(Int32), actual_payment_date Nullable(Date), scheduled_payment_date Nullable(Date), installment_amount Nullable(Decimal(18, 4)), principal_component Nullable(Decimal(18, 4)), interest_component Nullable(Decimal(18, 4)), kkdf_component Nullable(Decimal(18, 4)), bsmv_component Nullable(Decimal(18, 4)), installment_status Nullable(Enum8('A' = 1, 'K' = 2)), remaining_principal Nullable(Decimal(18, 4)), remaining_interest Nullable(Decimal(18, 4)), remaining_kkdf Nullable(Decimal(18, 4)), remaining_bsmv Nullable(Decimal(18, 4)), inserted_at DateTime DEFAULT now() ) ENGINE = MergeTree() PARTITION BY (tenant_id, loan_type) ORDER BY (loan_account_number, installment_number) ), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String const&>(int, FormatStringHelperImpl<std::type_identity<String const&>::type>, String const&) @ 0x0000000007951590 in /usr/bin/clickhouse
2. DB::checkKeyExpression(DB::ExpressionActions const&, DB::Block const&, String const&, bool) @ 0x0000000011d23da8 in /usr/bin/clickhouse
3. DB::MergeTreeData::checkProperties(DB::StorageInMemoryMetadata const&, DB::StorageInMemoryMetadata const&, bool, bool, std::shared_ptr<DB::Context const>) const @ 0x0000000011d23254 in /usr/bin/clickhouse
4. DB::MergeTreeData::MergeTreeData(DB::StorageID const&, DB::StorageInMemoryMetadata const&, std::shared_ptr<DB::Context>, String const&, DB::MergeTreeData::MergingParams const&, std::unique_ptr<DB::MergeTreeSettings, std::default_delete<DB::MergeTreeSettings>>, bool, bool, std::function<void (String const&)>) @ 0x0000000011d1f45c in /usr/bin/clickhouse
5. DB::StorageMergeTree::StorageMergeTree(DB::StorageID const&, String const&, DB::StorageInMemoryMetadata const&, bool, std::shared_ptr<DB::Context>, String const&, DB::MergeTreeData::MergingParams const&, std::unique_ptr<DB::MergeTreeSettings, std::default_delete<DB::MergeTreeSettings>>, bool) @ 0x000000001200af54 in /usr/bin/clickhouse
6. DB::create(DB::StorageFactory::Arguments const&) @ 0x0000000012008464 in /usr/bin/clickhouse
7. DB::StorageFactory::get(DB::ASTCreateQuery const&, String const&, std::shared_ptr<DB::Context>, std::shared_ptr<DB::Context>, DB::ColumnsDescription const&, DB::ConstraintsDescription const&, bool) const @ 0x000000001181d01c in /usr/bin/clickhouse
8. DB::InterpreterCreateQuery::doCreateTable(DB::ASTCreateQuery&, DB::InterpreterCreateQuery::TableProperties const&, std::unique_ptr<DB::DDLGuard, std::default_delete<DB::DDLGuard>>&) @ 0x0000000010f9d6c4 in /usr/bin/clickhouse
9. DB::InterpreterCreateQuery::createTable(DB::ASTCreateQuery&) @ 0x0000000010f97518 in /usr/bin/clickhouse
10. DB::InterpreterCreateQuery::execute() @ 0x0000000010fa2e40 in /usr/bin/clickhouse
11. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c98d0 in /usr/bin/clickhouse
12. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
13. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
14. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
15. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
16. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
17. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
18. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
19. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
20. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
21. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.05 13:31:15.367194 [ 47 ] {1d207383-0483-4789-8a9f-b2658dbfb1f8} <Error> DynamicQueryHandler: Code: 44. DB::Exception: Sorting key contains nullable columns, but merge tree setting `allow_nullable_key` is disabled. (ILLEGAL_COLUMN), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String const&>(int, FormatStringHelperImpl<std::type_identity<String const&>::type>, String const&) @ 0x0000000007951590 in /usr/bin/clickhouse
2. DB::checkKeyExpression(DB::ExpressionActions const&, DB::Block const&, String const&, bool) @ 0x0000000011d23da8 in /usr/bin/clickhouse
3. DB::MergeTreeData::checkProperties(DB::StorageInMemoryMetadata const&, DB::StorageInMemoryMetadata const&, bool, bool, std::shared_ptr<DB::Context const>) const @ 0x0000000011d23254 in /usr/bin/clickhouse
4. DB::MergeTreeData::MergeTreeData(DB::StorageID const&, DB::StorageInMemoryMetadata const&, std::shared_ptr<DB::Context>, String const&, DB::MergeTreeData::MergingParams const&, std::unique_ptr<DB::MergeTreeSettings, std::default_delete<DB::MergeTreeSettings>>, bool, bool, std::function<void (String const&)>) @ 0x0000000011d1f45c in /usr/bin/clickhouse
5. DB::StorageMergeTree::StorageMergeTree(DB::StorageID const&, String const&, DB::StorageInMemoryMetadata const&, bool, std::shared_ptr<DB::Context>, String const&, DB::MergeTreeData::MergingParams const&, std::unique_ptr<DB::MergeTreeSettings, std::default_delete<DB::MergeTreeSettings>>, bool) @ 0x000000001200af54 in /usr/bin/clickhouse
6. DB::create(DB::StorageFactory::Arguments const&) @ 0x0000000012008464 in /usr/bin/clickhouse
7. DB::StorageFactory::get(DB::ASTCreateQuery const&, String const&, std::shared_ptr<DB::Context>, std::shared_ptr<DB::Context>, DB::ColumnsDescription const&, DB::ConstraintsDescription const&, bool) const @ 0x000000001181d01c in /usr/bin/clickhouse
8. DB::InterpreterCreateQuery::doCreateTable(DB::ASTCreateQuery&, DB::InterpreterCreateQuery::TableProperties const&, std::unique_ptr<DB::DDLGuard, std::default_delete<DB::DDLGuard>>&) @ 0x0000000010f9d6c4 in /usr/bin/clickhouse
9. DB::InterpreterCreateQuery::createTable(DB::ASTCreateQuery&) @ 0x0000000010f97518 in /usr/bin/clickhouse
10. DB::InterpreterCreateQuery::execute() @ 0x0000000010fa2e40 in /usr/bin/clickhouse
11. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c98d0 in /usr/bin/clickhouse
12. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
13. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
14. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
15. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
16. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
17. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
18. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
19. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
20. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
21. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.06 21:55:00.447626 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.06 21:55:00.482701 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.06 21:55:00.681986 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.06 21:55:01.218359 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.06 21:55:01.230523 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.06 21:55:01.242291 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.06 21:55:01.250940 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 01:56:35.093274 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 01:56:35.112280 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 01:56:35.461780 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 01:56:35.800559 [ 294 ] {} <Warning> system.asynchronous_metric_log (b21fdeb2-3e27-48ad-a49b-f960ce912677): Removing temporary directory /var/lib/clickhouse/store/b21/b21fdeb2-3e27-48ad-a49b-f960ce912677/tmp_merge_202602_34558_36726_1558/
2026.02.07 01:56:36.085410 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 01:56:36.093866 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 01:56:36.102107 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 01:56:36.110375 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 02:54:23.423105 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 02:54:23.436101 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 02:54:23.567743 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 02:54:24.494087 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 02:54:24.505078 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 02:54:24.516538 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 02:54:24.526312 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:02:55.430909 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 03:02:55.454997 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 03:02:55.633064 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:02:56.113027 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:02:56.122086 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:02:56.131761 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:02:56.140595 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:06:29.124289 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 03:06:29.138365 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 03:06:29.280559 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:06:29.689604 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:06:29.699257 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:06:29.709698 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:06:29.721060 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:24:58.904644 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 03:24:58.912539 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 03:24:58.973881 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:24:59.315221 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:24:59.325543 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:24:59.334573 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:24:59.343173 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 03:34:43.844928 [ 47 ] {6b789747-12c3-4c91-b012-1ab55357844e} <Error> DynamicQueryHandler: Code: 618. DB::Exception: LZ4 decompression failed. LZ4F version: 100. Error: ERROR_frameType_unknown. (LZ4_DECODER_FAILED), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<int, char const*, String>(int, FormatStringHelperImpl<std::type_identity<int>::type, std::type_identity<char const*>::type, std::type_identity<String>::type>, int&&, char const*&&, String&&) @ 0x000000000e95ad5c in /usr/bin/clickhouse
2. DB::Lz4InflatingReadBuffer::nextImpl() @ 0x000000000e95ac4c in /usr/bin/clickhouse
3. DB::(anonymous namespace)::ReadBufferWrapper<std::nullptr_t>::nextImpl() @ 0x00000000104294a4 in /usr/bin/clickhouse
4. DB::ConcatReadBuffer::nextImpl() @ 0x00000000109a29e8 in /usr/bin/clickhouse
5. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cbca0 in /usr/bin/clickhouse
6. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
7. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
8. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
9. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
10. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
11. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
12. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
13. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
14. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 03:39:30.800073 [ 47 ] {bfdea208-0710-46ff-8d49-0bbd0ab46ac9} <Error> DynamicQueryHandler: Code: 618. DB::Exception: LZ4 decompression failed. LZ4F version: 100. Error: ERROR_frameType_unknown. (LZ4_DECODER_FAILED), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<int, char const*, String>(int, FormatStringHelperImpl<std::type_identity<int>::type, std::type_identity<char const*>::type, std::type_identity<String>::type>, int&&, char const*&&, String&&) @ 0x000000000e95ad5c in /usr/bin/clickhouse
2. DB::Lz4InflatingReadBuffer::nextImpl() @ 0x000000000e95ac4c in /usr/bin/clickhouse
3. DB::(anonymous namespace)::ReadBufferWrapper<std::nullptr_t>::nextImpl() @ 0x00000000104294a4 in /usr/bin/clickhouse
4. DB::ConcatReadBuffer::nextImpl() @ 0x00000000109a29e8 in /usr/bin/clickhouse
5. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cbca0 in /usr/bin/clickhouse
6. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
7. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
8. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
9. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
10. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
11. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
12. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
13. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
14. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 03:45:02.151676 [ 47 ] {5afaca80-59e7-47a0-9e25-b4498d70fff4} <Error> DynamicQueryHandler: Code: 618. DB::Exception: LZ4 decompression failed. LZ4F version: 100. Error: ERROR_frameType_unknown. (LZ4_DECODER_FAILED), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<int, char const*, String>(int, FormatStringHelperImpl<std::type_identity<int>::type, std::type_identity<char const*>::type, std::type_identity<String>::type>, int&&, char const*&&, String&&) @ 0x000000000e95ad5c in /usr/bin/clickhouse
2. DB::Lz4InflatingReadBuffer::nextImpl() @ 0x000000000e95ac4c in /usr/bin/clickhouse
3. DB::(anonymous namespace)::ReadBufferWrapper<std::nullptr_t>::nextImpl() @ 0x00000000104294a4 in /usr/bin/clickhouse
4. DB::ConcatReadBuffer::nextImpl() @ 0x00000000109a29e8 in /usr/bin/clickhouse
5. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cbca0 in /usr/bin/clickhouse
6. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
7. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
8. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
9. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
10. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
11. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
12. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
13. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
14. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:05:39.348024 [ 47 ] {77396071-8a4c-46c0-9b4f-1f2ae62c87da} <Error> DynamicQueryHandler: Code: 618. DB::Exception: LZ4 decompression failed. LZ4F version: 100. Error: ERROR_frameType_unknown. (LZ4_DECODER_FAILED), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<int, char const*, String>(int, FormatStringHelperImpl<std::type_identity<int>::type, std::type_identity<char const*>::type, std::type_identity<String>::type>, int&&, char const*&&, String&&) @ 0x000000000e95ad5c in /usr/bin/clickhouse
2. DB::Lz4InflatingReadBuffer::nextImpl() @ 0x000000000e95ac4c in /usr/bin/clickhouse
3. DB::(anonymous namespace)::ReadBufferWrapper<std::nullptr_t>::nextImpl() @ 0x00000000104294a4 in /usr/bin/clickhouse
4. DB::ConcatReadBuffer::nextImpl() @ 0x00000000109a29e8 in /usr/bin/clickhouse
5. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cbca0 in /usr/bin/clickhouse
6. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
7. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
8. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
9. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
10. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
11. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
12. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
13. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
14. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:15:42.077614 [ 47 ] {1502ca1e-5c21-4990-966f-19829efcabf2} <Error> DynamicQueryHandler: Code: 618. DB::Exception: LZ4 decompression failed. LZ4F version: 100. Error: ERROR_frameType_unknown. (LZ4_DECODER_FAILED), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<int, char const*, String>(int, FormatStringHelperImpl<std::type_identity<int>::type, std::type_identity<char const*>::type, std::type_identity<String>::type>, int&&, char const*&&, String&&) @ 0x000000000e95ad5c in /usr/bin/clickhouse
2. DB::Lz4InflatingReadBuffer::nextImpl() @ 0x000000000e95ac4c in /usr/bin/clickhouse
3. DB::(anonymous namespace)::ReadBufferWrapper<std::nullptr_t>::nextImpl() @ 0x00000000104294a4 in /usr/bin/clickhouse
4. DB::ConcatReadBuffer::nextImpl() @ 0x00000000109a29e8 in /usr/bin/clickhouse
5. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cbca0 in /usr/bin/clickhouse
6. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
7. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
8. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
9. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
10. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
11. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
12. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
13. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
14. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:22.688280 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 04:17:22.735197 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 04:17:22.883320 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 04:17:23.872791 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 04:17:23.888321 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 04:17:23.912780 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 04:17:23.925594 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 04:17:39.758365 [ 48 ] {3ed2369e-493b-4d1b-a8ca-a1ba89b82399} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_type) is found inside another aggregate function in query: While processing topK(1)(customer_type). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(customer_type), countIf(customer_type IS NULL), topK(1)(customer_type)[1] AS most_freq, countIf(customer_type = topK(1)(customer_type)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:39.764569 [ 48 ] {3ed2369e-493b-4d1b-a8ca-a1ba89b82399} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_type) is found inside another aggregate function in query: While processing topK(1)(customer_type). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:39.779552 [ 48 ] {edb04963-ca42-4380-91f4-870641527da1} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_product_type) is found inside another aggregate function in query: While processing topK(1)(loan_product_type). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(loan_product_type), countIf(loan_product_type IS NULL), topK(1)(loan_product_type)[1] AS most_freq, countIf(loan_product_type = topK(1)(loan_product_type)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:39.782000 [ 48 ] {edb04963-ca42-4380-91f4-870641527da1} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_product_type) is found inside another aggregate function in query: While processing topK(1)(loan_product_type). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:39.798020 [ 48 ] {91e5b885-804b-49b0-9c9f-944a84353a93} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_code) is found inside another aggregate function in query: While processing topK(1)(loan_status_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(loan_status_code), countIf(loan_status_code IS NULL), topK(1)(loan_status_code)[1] AS most_freq, countIf(loan_status_code = topK(1)(loan_status_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:39.799686 [ 48 ] {91e5b885-804b-49b0-9c9f-944a84353a93} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_code) is found inside another aggregate function in query: While processing topK(1)(loan_status_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:39.814872 [ 48 ] {37286c6f-2d6e-430b-9e8d-0268eb4e151f} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_flag) is found inside another aggregate function in query: While processing topK(1)(loan_status_flag). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(loan_status_flag), countIf(loan_status_flag IS NULL), topK(1)(loan_status_flag)[1] AS most_freq, countIf(loan_status_flag = topK(1)(loan_status_flag)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:39.826604 [ 48 ] {37286c6f-2d6e-430b-9e8d-0268eb4e151f} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_flag) is found inside another aggregate function in query: While processing topK(1)(loan_status_flag). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:39.829284 [ 48 ] {a32db976-1f35-4740-9c54-3b5004cef4e8} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(insurance_included) is found inside another aggregate function in query: While processing topK(1)(insurance_included). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(insurance_included), countIf(insurance_included IS NULL), topK(1)(insurance_included)[1] AS most_freq, countIf(insurance_included = topK(1)(insurance_included)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:39.829771 [ 48 ] {a32db976-1f35-4740-9c54-3b5004cef4e8} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(insurance_included) is found inside another aggregate function in query: While processing topK(1)(insurance_included). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:39.846748 [ 48 ] {70a5e079-5f59-434f-974c-86ca8b8a2130} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(sector_code) is found inside another aggregate function in query: While processing topK(1)(sector_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(sector_code), countIf(sector_code IS NULL), topK(1)(sector_code)[1] AS most_freq, countIf(sector_code = topK(1)(sector_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:39.849161 [ 48 ] {70a5e079-5f59-434f-974c-86ca8b8a2130} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(sector_code) is found inside another aggregate function in query: While processing topK(1)(sector_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:39.852798 [ 48 ] {628ae2b2-4d78-421a-be6f-2973517fcf41} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_segment) is found inside another aggregate function in query: While processing topK(1)(customer_segment). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(customer_segment), countIf(customer_segment IS NULL), topK(1)(customer_segment)[1] AS most_freq, countIf(customer_segment = topK(1)(customer_segment)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:39.853125 [ 48 ] {628ae2b2-4d78-421a-be6f-2973517fcf41} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_segment) is found inside another aggregate function in query: While processing topK(1)(customer_segment). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:39.863611 [ 48 ] {fc80eb51-7f9f-4ee6-8c04-cc1d2506b65b} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(risk_class) is found inside another aggregate function in query: While processing topK(1)(risk_class). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(risk_class), countIf(risk_class IS NULL), topK(1)(risk_class)[1] AS most_freq, countIf(risk_class = topK(1)(risk_class)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:39.864149 [ 48 ] {fc80eb51-7f9f-4ee6-8c04-cc1d2506b65b} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(risk_class) is found inside another aggregate function in query: While processing topK(1)(risk_class). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:40.266799 [ 48 ] {aa9758be-c7b9-49e7-827b-e4dc8f92766f} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(internal_rating) is found inside another aggregate function in query: While processing topK(1)(internal_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(internal_rating), countIf(internal_rating IS NULL), topK(1)(internal_rating)[1] AS most_freq, countIf(internal_rating = topK(1)(internal_rating)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:40.267077 [ 48 ] {aa9758be-c7b9-49e7-827b-e4dc8f92766f} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(internal_rating) is found inside another aggregate function in query: While processing topK(1)(internal_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:40.268912 [ 48 ] {ed7d71ba-bf38-42fa-82c0-32f2d5201c3a} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(internal_credit_rating) is found inside another aggregate function in query: While processing topK(1)(internal_credit_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(internal_credit_rating), countIf(internal_credit_rating IS NULL), topK(1)(internal_credit_rating)[1] AS most_freq, countIf(internal_credit_rating = topK(1)(internal_credit_rating)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:40.269338 [ 48 ] {ed7d71ba-bf38-42fa-82c0-32f2d5201c3a} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(internal_credit_rating) is found inside another aggregate function in query: While processing topK(1)(internal_credit_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:40.271142 [ 48 ] {fc999063-7c12-4665-8d4b-9191d46ffc4b} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(external_rating) is found inside another aggregate function in query: While processing topK(1)(external_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(external_rating), countIf(external_rating IS NULL), topK(1)(external_rating)[1] AS most_freq, countIf(external_rating = topK(1)(external_rating)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:40.271549 [ 48 ] {fc999063-7c12-4665-8d4b-9191d46ffc4b} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(external_rating) is found inside another aggregate function in query: While processing topK(1)(external_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:40.273224 [ 48 ] {9ca37fcb-d815-449e-bf02-3a7634b166b2} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_province_code) is found inside another aggregate function in query: While processing topK(1)(customer_province_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(customer_province_code), countIf(customer_province_code IS NULL), topK(1)(customer_province_code)[1] AS most_freq, countIf(customer_province_code = topK(1)(customer_province_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:40.274623 [ 48 ] {9ca37fcb-d815-449e-bf02-3a7634b166b2} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_province_code) is found inside another aggregate function in query: While processing topK(1)(customer_province_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:40.276456 [ 48 ] {08a2994d-0943-4a89-9bf9-3a4b781fb128} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_district_code) is found inside another aggregate function in query: While processing topK(1)(customer_district_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(customer_district_code), countIf(customer_district_code IS NULL), topK(1)(customer_district_code)[1] AS most_freq, countIf(customer_district_code = topK(1)(customer_district_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:40.276777 [ 48 ] {08a2994d-0943-4a89-9bf9-3a4b781fb128} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_district_code) is found inside another aggregate function in query: While processing topK(1)(customer_district_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:40.278697 [ 48 ] {761cc071-0212-4ea3-89b0-5b11c92be882} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_region_code) is found inside another aggregate function in query: While processing topK(1)(customer_region_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(customer_region_code), countIf(customer_region_code IS NULL), topK(1)(customer_region_code)[1] AS most_freq, countIf(customer_region_code = topK(1)(customer_region_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:40.279080 [ 48 ] {761cc071-0212-4ea3-89b0-5b11c92be882} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_region_code) is found inside another aggregate function in query: While processing topK(1)(customer_region_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:17:40.366937 [ 48 ] {5a8ae092-7b96-46ec-93b9-a5a33bf6b2f7} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(installment_status) is found inside another aggregate function in query: While processing topK(1)(installment_status). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:38556) (in query:  SELECT uniqExact(installment_status), countIf(installment_status IS NULL), topK(1)(installment_status)[1] AS most_freq, countIf(installment_status = topK(1)(installment_status)[1]) FROM stg_bank001_commercial_payments FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:17:40.367369 [ 48 ] {5a8ae092-7b96-46ec-93b9-a5a33bf6b2f7} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(installment_status) is found inside another aggregate function in query: While processing topK(1)(installment_status). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.444064 [ 48 ] {c9e107fb-5543-4708-8316-817eaa50915f} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_type) is found inside another aggregate function in query: While processing topK(1)(customer_type). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(customer_type), countIf(customer_type IS NULL), topK(1)(customer_type)[1] AS most_freq, countIf(customer_type = topK(1)(customer_type)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.444496 [ 48 ] {c9e107fb-5543-4708-8316-817eaa50915f} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_type) is found inside another aggregate function in query: While processing topK(1)(customer_type). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.446682 [ 48 ] {af2190dc-c58f-415b-88ea-aaedb91291fc} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_product_type) is found inside another aggregate function in query: While processing topK(1)(loan_product_type). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(loan_product_type), countIf(loan_product_type IS NULL), topK(1)(loan_product_type)[1] AS most_freq, countIf(loan_product_type = topK(1)(loan_product_type)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.447237 [ 48 ] {af2190dc-c58f-415b-88ea-aaedb91291fc} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_product_type) is found inside another aggregate function in query: While processing topK(1)(loan_product_type). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.449141 [ 48 ] {6472da88-dad1-43bf-9006-0efb41318af1} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_code) is found inside another aggregate function in query: While processing topK(1)(loan_status_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(loan_status_code), countIf(loan_status_code IS NULL), topK(1)(loan_status_code)[1] AS most_freq, countIf(loan_status_code = topK(1)(loan_status_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.449447 [ 48 ] {6472da88-dad1-43bf-9006-0efb41318af1} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_code) is found inside another aggregate function in query: While processing topK(1)(loan_status_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.450785 [ 48 ] {951af372-e93d-4366-9c5f-12fee772f034} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_flag) is found inside another aggregate function in query: While processing topK(1)(loan_status_flag). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(loan_status_flag), countIf(loan_status_flag IS NULL), topK(1)(loan_status_flag)[1] AS most_freq, countIf(loan_status_flag = topK(1)(loan_status_flag)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.451084 [ 48 ] {951af372-e93d-4366-9c5f-12fee772f034} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_flag) is found inside another aggregate function in query: While processing topK(1)(loan_status_flag). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.452402 [ 48 ] {3d366ea5-1132-42be-8ef5-a318266853c9} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(insurance_included) is found inside another aggregate function in query: While processing topK(1)(insurance_included). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(insurance_included), countIf(insurance_included IS NULL), topK(1)(insurance_included)[1] AS most_freq, countIf(insurance_included = topK(1)(insurance_included)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.452772 [ 48 ] {3d366ea5-1132-42be-8ef5-a318266853c9} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(insurance_included) is found inside another aggregate function in query: While processing topK(1)(insurance_included). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.455072 [ 48 ] {e52141d9-b7c0-4cdc-8816-078da76fcbc7} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(sector_code) is found inside another aggregate function in query: While processing topK(1)(sector_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(sector_code), countIf(sector_code IS NULL), topK(1)(sector_code)[1] AS most_freq, countIf(sector_code = topK(1)(sector_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.455490 [ 48 ] {e52141d9-b7c0-4cdc-8816-078da76fcbc7} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(sector_code) is found inside another aggregate function in query: While processing topK(1)(sector_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.456950 [ 48 ] {edfa1c17-1908-47b5-8196-7669ba02bd49} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_segment) is found inside another aggregate function in query: While processing topK(1)(customer_segment). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(customer_segment), countIf(customer_segment IS NULL), topK(1)(customer_segment)[1] AS most_freq, countIf(customer_segment = topK(1)(customer_segment)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.457233 [ 48 ] {edfa1c17-1908-47b5-8196-7669ba02bd49} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_segment) is found inside another aggregate function in query: While processing topK(1)(customer_segment). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.458553 [ 48 ] {4f664927-bbcf-4937-8e84-5a351704dcce} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(risk_class) is found inside another aggregate function in query: While processing topK(1)(risk_class). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(risk_class), countIf(risk_class IS NULL), topK(1)(risk_class)[1] AS most_freq, countIf(risk_class = topK(1)(risk_class)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.458884 [ 48 ] {4f664927-bbcf-4937-8e84-5a351704dcce} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(risk_class) is found inside another aggregate function in query: While processing topK(1)(risk_class). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.518463 [ 48 ] {902e6cc8-f0fd-4a98-ad52-fe012784befa} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(internal_rating) is found inside another aggregate function in query: While processing topK(1)(internal_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(internal_rating), countIf(internal_rating IS NULL), topK(1)(internal_rating)[1] AS most_freq, countIf(internal_rating = topK(1)(internal_rating)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.518790 [ 48 ] {902e6cc8-f0fd-4a98-ad52-fe012784befa} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(internal_rating) is found inside another aggregate function in query: While processing topK(1)(internal_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.520344 [ 48 ] {b752bdfb-615d-42b7-a367-d9c6fa23ac00} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(internal_credit_rating) is found inside another aggregate function in query: While processing topK(1)(internal_credit_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(internal_credit_rating), countIf(internal_credit_rating IS NULL), topK(1)(internal_credit_rating)[1] AS most_freq, countIf(internal_credit_rating = topK(1)(internal_credit_rating)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.520624 [ 48 ] {b752bdfb-615d-42b7-a367-d9c6fa23ac00} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(internal_credit_rating) is found inside another aggregate function in query: While processing topK(1)(internal_credit_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.522268 [ 48 ] {df922da9-8370-4551-a0db-84c1f3f385d3} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(external_rating) is found inside another aggregate function in query: While processing topK(1)(external_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(external_rating), countIf(external_rating IS NULL), topK(1)(external_rating)[1] AS most_freq, countIf(external_rating = topK(1)(external_rating)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.522506 [ 48 ] {df922da9-8370-4551-a0db-84c1f3f385d3} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(external_rating) is found inside another aggregate function in query: While processing topK(1)(external_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.524254 [ 48 ] {a63a21cc-1dc0-4a06-8db8-d3793e670391} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_province_code) is found inside another aggregate function in query: While processing topK(1)(customer_province_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(customer_province_code), countIf(customer_province_code IS NULL), topK(1)(customer_province_code)[1] AS most_freq, countIf(customer_province_code = topK(1)(customer_province_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.524512 [ 48 ] {a63a21cc-1dc0-4a06-8db8-d3793e670391} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_province_code) is found inside another aggregate function in query: While processing topK(1)(customer_province_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.525866 [ 48 ] {b0ee0dee-85c3-4a6b-a08f-75b4ecaceb70} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_district_code) is found inside another aggregate function in query: While processing topK(1)(customer_district_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(customer_district_code), countIf(customer_district_code IS NULL), topK(1)(customer_district_code)[1] AS most_freq, countIf(customer_district_code = topK(1)(customer_district_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.526134 [ 48 ] {b0ee0dee-85c3-4a6b-a08f-75b4ecaceb70} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_district_code) is found inside another aggregate function in query: While processing topK(1)(customer_district_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.528140 [ 48 ] {84559a17-e01b-4560-bdbf-f1a16d87b668} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_region_code) is found inside another aggregate function in query: While processing topK(1)(customer_region_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(customer_region_code), countIf(customer_region_code IS NULL), topK(1)(customer_region_code)[1] AS most_freq, countIf(customer_region_code = topK(1)(customer_region_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.528386 [ 48 ] {84559a17-e01b-4560-bdbf-f1a16d87b668} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_region_code) is found inside another aggregate function in query: While processing topK(1)(customer_region_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:26:07.575361 [ 48 ] {68dcdb54-84f5-45d7-a173-deba5c49c084} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(installment_status) is found inside another aggregate function in query: While processing topK(1)(installment_status). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:59694) (in query:  SELECT uniqExact(installment_status), countIf(installment_status IS NULL), topK(1)(installment_status)[1] AS most_freq, countIf(installment_status = topK(1)(installment_status)[1]) FROM stg_bank001_commercial_payments FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:26:07.575630 [ 48 ] {68dcdb54-84f5-45d7-a173-deba5c49c084} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(installment_status) is found inside another aggregate function in query: While processing topK(1)(installment_status). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.518914 [ 48 ] {495dfee0-bcd2-4949-bd58-db9a09fa3fec} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_type) is found inside another aggregate function in query: While processing topK(1)(customer_type). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(customer_type), countIf(customer_type IS NULL), topK(1)(customer_type)[1] AS most_freq, countIf(customer_type = topK(1)(customer_type)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.519403 [ 48 ] {495dfee0-bcd2-4949-bd58-db9a09fa3fec} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_type) is found inside another aggregate function in query: While processing topK(1)(customer_type). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.521352 [ 48 ] {73c15ff8-73ef-4852-976d-838a2a37a61a} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_product_type) is found inside another aggregate function in query: While processing topK(1)(loan_product_type). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(loan_product_type), countIf(loan_product_type IS NULL), topK(1)(loan_product_type)[1] AS most_freq, countIf(loan_product_type = topK(1)(loan_product_type)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.521606 [ 48 ] {73c15ff8-73ef-4852-976d-838a2a37a61a} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_product_type) is found inside another aggregate function in query: While processing topK(1)(loan_product_type). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.523019 [ 48 ] {61dccd9e-e063-4dab-b58a-3dc26bebf53a} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_code) is found inside another aggregate function in query: While processing topK(1)(loan_status_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(loan_status_code), countIf(loan_status_code IS NULL), topK(1)(loan_status_code)[1] AS most_freq, countIf(loan_status_code = topK(1)(loan_status_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.523288 [ 48 ] {61dccd9e-e063-4dab-b58a-3dc26bebf53a} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_code) is found inside another aggregate function in query: While processing topK(1)(loan_status_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.525227 [ 48 ] {ede219f3-0005-4a62-b487-89c2a68ee343} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_flag) is found inside another aggregate function in query: While processing topK(1)(loan_status_flag). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(loan_status_flag), countIf(loan_status_flag IS NULL), topK(1)(loan_status_flag)[1] AS most_freq, countIf(loan_status_flag = topK(1)(loan_status_flag)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.525494 [ 48 ] {ede219f3-0005-4a62-b487-89c2a68ee343} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_flag) is found inside another aggregate function in query: While processing topK(1)(loan_status_flag). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.526994 [ 48 ] {336f9713-6eea-4b65-a40f-dcc345126cd4} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(insurance_included) is found inside another aggregate function in query: While processing topK(1)(insurance_included). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(insurance_included), countIf(insurance_included IS NULL), topK(1)(insurance_included)[1] AS most_freq, countIf(insurance_included = topK(1)(insurance_included)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.527256 [ 48 ] {336f9713-6eea-4b65-a40f-dcc345126cd4} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(insurance_included) is found inside another aggregate function in query: While processing topK(1)(insurance_included). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.528690 [ 48 ] {468c997c-f47d-4e84-b5c4-d30de37e70d3} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(sector_code) is found inside another aggregate function in query: While processing topK(1)(sector_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(sector_code), countIf(sector_code IS NULL), topK(1)(sector_code)[1] AS most_freq, countIf(sector_code = topK(1)(sector_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.528944 [ 48 ] {468c997c-f47d-4e84-b5c4-d30de37e70d3} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(sector_code) is found inside another aggregate function in query: While processing topK(1)(sector_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.530414 [ 48 ] {b9014b5c-c25f-4212-a5e4-1c24511e2a77} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_segment) is found inside another aggregate function in query: While processing topK(1)(customer_segment). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(customer_segment), countIf(customer_segment IS NULL), topK(1)(customer_segment)[1] AS most_freq, countIf(customer_segment = topK(1)(customer_segment)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.530678 [ 48 ] {b9014b5c-c25f-4212-a5e4-1c24511e2a77} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_segment) is found inside another aggregate function in query: While processing topK(1)(customer_segment). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.532060 [ 48 ] {33a45cfb-a048-4a60-84cf-c3244e16d993} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(risk_class) is found inside another aggregate function in query: While processing topK(1)(risk_class). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(risk_class), countIf(risk_class IS NULL), topK(1)(risk_class)[1] AS most_freq, countIf(risk_class = topK(1)(risk_class)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.532325 [ 48 ] {33a45cfb-a048-4a60-84cf-c3244e16d993} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(risk_class) is found inside another aggregate function in query: While processing topK(1)(risk_class). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.611319 [ 48 ] {4f35805e-27e4-48b3-bdc6-80396313d0d6} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(internal_rating) is found inside another aggregate function in query: While processing topK(1)(internal_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(internal_rating), countIf(internal_rating IS NULL), topK(1)(internal_rating)[1] AS most_freq, countIf(internal_rating = topK(1)(internal_rating)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.611629 [ 48 ] {4f35805e-27e4-48b3-bdc6-80396313d0d6} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(internal_rating) is found inside another aggregate function in query: While processing topK(1)(internal_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.613612 [ 48 ] {c3cc7a0e-9653-4223-9d0c-8ccec0c7e50e} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(internal_credit_rating) is found inside another aggregate function in query: While processing topK(1)(internal_credit_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(internal_credit_rating), countIf(internal_credit_rating IS NULL), topK(1)(internal_credit_rating)[1] AS most_freq, countIf(internal_credit_rating = topK(1)(internal_credit_rating)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.613964 [ 48 ] {c3cc7a0e-9653-4223-9d0c-8ccec0c7e50e} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(internal_credit_rating) is found inside another aggregate function in query: While processing topK(1)(internal_credit_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.615902 [ 48 ] {e433454b-dbc6-49c3-b399-4821e6ae7ecb} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(external_rating) is found inside another aggregate function in query: While processing topK(1)(external_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(external_rating), countIf(external_rating IS NULL), topK(1)(external_rating)[1] AS most_freq, countIf(external_rating = topK(1)(external_rating)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.616217 [ 48 ] {e433454b-dbc6-49c3-b399-4821e6ae7ecb} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(external_rating) is found inside another aggregate function in query: While processing topK(1)(external_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.618012 [ 48 ] {b618de2f-54e2-4d04-b78f-cf5f1c6c73cd} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_province_code) is found inside another aggregate function in query: While processing topK(1)(customer_province_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(customer_province_code), countIf(customer_province_code IS NULL), topK(1)(customer_province_code)[1] AS most_freq, countIf(customer_province_code = topK(1)(customer_province_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.618325 [ 48 ] {b618de2f-54e2-4d04-b78f-cf5f1c6c73cd} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_province_code) is found inside another aggregate function in query: While processing topK(1)(customer_province_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.619914 [ 48 ] {f0389837-cfdd-4bc8-8b73-40b6a630242a} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_district_code) is found inside another aggregate function in query: While processing topK(1)(customer_district_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(customer_district_code), countIf(customer_district_code IS NULL), topK(1)(customer_district_code)[1] AS most_freq, countIf(customer_district_code = topK(1)(customer_district_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.620224 [ 48 ] {f0389837-cfdd-4bc8-8b73-40b6a630242a} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_district_code) is found inside another aggregate function in query: While processing topK(1)(customer_district_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.621968 [ 48 ] {c1dbc66c-15fc-41e2-9efd-c339d7f271f6} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_region_code) is found inside another aggregate function in query: While processing topK(1)(customer_region_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(customer_region_code), countIf(customer_region_code IS NULL), topK(1)(customer_region_code)[1] AS most_freq, countIf(customer_region_code = topK(1)(customer_region_code)[1]) FROM stg_bank001_commercial_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.622285 [ 48 ] {c1dbc66c-15fc-41e2-9efd-c339d7f271f6} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_region_code) is found inside another aggregate function in query: While processing topK(1)(customer_region_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:30:45.669216 [ 48 ] {9dedcb6e-db77-47de-9ebf-595865bcbff3} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(installment_status) is found inside another aggregate function in query: While processing topK(1)(installment_status). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:36354) (in query:  SELECT uniqExact(installment_status), countIf(installment_status IS NULL), topK(1)(installment_status)[1] AS most_freq, countIf(installment_status = topK(1)(installment_status)[1]) FROM stg_bank001_commercial_payments FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:30:45.669475 [ 48 ] {9dedcb6e-db77-47de-9ebf-595865bcbff3} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(installment_status) is found inside another aggregate function in query: While processing topK(1)(installment_status). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:09.933061 [ 48 ] {cfaaab81-4883-452d-84ea-268030593009} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_type) is found inside another aggregate function in query: While processing topK(1)(customer_type). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(customer_type), countIf(customer_type IS NULL), topK(1)(customer_type)[1] AS most_freq, countIf(customer_type = topK(1)(customer_type)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:09.933575 [ 48 ] {cfaaab81-4883-452d-84ea-268030593009} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_type) is found inside another aggregate function in query: While processing topK(1)(customer_type). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:09.935137 [ 48 ] {1539e924-00b5-4c58-a2eb-fc541e681753} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_product_type) is found inside another aggregate function in query: While processing topK(1)(loan_product_type). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(loan_product_type), countIf(loan_product_type IS NULL), topK(1)(loan_product_type)[1] AS most_freq, countIf(loan_product_type = topK(1)(loan_product_type)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:09.935392 [ 48 ] {1539e924-00b5-4c58-a2eb-fc541e681753} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_product_type) is found inside another aggregate function in query: While processing topK(1)(loan_product_type). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:09.937411 [ 48 ] {a59ce018-40cf-4a8d-9ed0-ba84ba359c39} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_code) is found inside another aggregate function in query: While processing topK(1)(loan_status_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(loan_status_code), countIf(loan_status_code IS NULL), topK(1)(loan_status_code)[1] AS most_freq, countIf(loan_status_code = topK(1)(loan_status_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:09.937685 [ 48 ] {a59ce018-40cf-4a8d-9ed0-ba84ba359c39} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_code) is found inside another aggregate function in query: While processing topK(1)(loan_status_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:09.939119 [ 48 ] {1d76a321-1d0c-4ae4-8f5e-fd1310e59bdc} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_flag) is found inside another aggregate function in query: While processing topK(1)(loan_status_flag). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(loan_status_flag), countIf(loan_status_flag IS NULL), topK(1)(loan_status_flag)[1] AS most_freq, countIf(loan_status_flag = topK(1)(loan_status_flag)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:09.939374 [ 48 ] {1d76a321-1d0c-4ae4-8f5e-fd1310e59bdc} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_flag) is found inside another aggregate function in query: While processing topK(1)(loan_status_flag). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:09.940676 [ 48 ] {1e504b54-1123-4e07-b136-ec63c9357a5e} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(insurance_included) is found inside another aggregate function in query: While processing topK(1)(insurance_included). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(insurance_included), countIf(insurance_included IS NULL), topK(1)(insurance_included)[1] AS most_freq, countIf(insurance_included = topK(1)(insurance_included)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:09.940935 [ 48 ] {1e504b54-1123-4e07-b136-ec63c9357a5e} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(insurance_included) is found inside another aggregate function in query: While processing topK(1)(insurance_included). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:09.942231 [ 48 ] {9af8835b-7dd8-4f51-8060-e30acb190e44} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(sector_code) is found inside another aggregate function in query: While processing topK(1)(sector_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(sector_code), countIf(sector_code IS NULL), topK(1)(sector_code)[1] AS most_freq, countIf(sector_code = topK(1)(sector_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:09.942482 [ 48 ] {9af8835b-7dd8-4f51-8060-e30acb190e44} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(sector_code) is found inside another aggregate function in query: While processing topK(1)(sector_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:09.943760 [ 48 ] {f3a811bf-c81c-4f63-bb99-52db4796eb73} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_segment) is found inside another aggregate function in query: While processing topK(1)(customer_segment). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(customer_segment), countIf(customer_segment IS NULL), topK(1)(customer_segment)[1] AS most_freq, countIf(customer_segment = topK(1)(customer_segment)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:09.944055 [ 48 ] {f3a811bf-c81c-4f63-bb99-52db4796eb73} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_segment) is found inside another aggregate function in query: While processing topK(1)(customer_segment). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:09.945419 [ 48 ] {76f4e6b5-ade1-4630-863d-3675ddf7d8ab} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(risk_class) is found inside another aggregate function in query: While processing topK(1)(risk_class). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(risk_class), countIf(risk_class IS NULL), topK(1)(risk_class)[1] AS most_freq, countIf(risk_class = topK(1)(risk_class)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:09.945674 [ 48 ] {76f4e6b5-ade1-4630-863d-3675ddf7d8ab} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(risk_class) is found inside another aggregate function in query: While processing topK(1)(risk_class). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:10.005855 [ 48 ] {9931d761-5d27-45a9-b9f7-6fd7dee2f8b1} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(internal_rating) is found inside another aggregate function in query: While processing topK(1)(internal_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(internal_rating), countIf(internal_rating IS NULL), topK(1)(internal_rating)[1] AS most_freq, countIf(internal_rating = topK(1)(internal_rating)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:10.006057 [ 48 ] {9931d761-5d27-45a9-b9f7-6fd7dee2f8b1} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(internal_rating) is found inside another aggregate function in query: While processing topK(1)(internal_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:10.007327 [ 48 ] {eccadaec-52b6-4750-8e73-86a7f068ed4b} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(internal_credit_rating) is found inside another aggregate function in query: While processing topK(1)(internal_credit_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(internal_credit_rating), countIf(internal_credit_rating IS NULL), topK(1)(internal_credit_rating)[1] AS most_freq, countIf(internal_credit_rating = topK(1)(internal_credit_rating)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:10.007540 [ 48 ] {eccadaec-52b6-4750-8e73-86a7f068ed4b} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(internal_credit_rating) is found inside another aggregate function in query: While processing topK(1)(internal_credit_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:10.008709 [ 48 ] {68d33691-fa84-45e1-bb5c-a910e7e24a5c} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(external_rating) is found inside another aggregate function in query: While processing topK(1)(external_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(external_rating), countIf(external_rating IS NULL), topK(1)(external_rating)[1] AS most_freq, countIf(external_rating = topK(1)(external_rating)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:10.008884 [ 48 ] {68d33691-fa84-45e1-bb5c-a910e7e24a5c} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(external_rating) is found inside another aggregate function in query: While processing topK(1)(external_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:10.010067 [ 48 ] {c3ccbe7c-be2a-432d-b3c4-e196872ef79b} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_province_code) is found inside another aggregate function in query: While processing topK(1)(customer_province_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(customer_province_code), countIf(customer_province_code IS NULL), topK(1)(customer_province_code)[1] AS most_freq, countIf(customer_province_code = topK(1)(customer_province_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:10.010345 [ 48 ] {c3ccbe7c-be2a-432d-b3c4-e196872ef79b} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_province_code) is found inside another aggregate function in query: While processing topK(1)(customer_province_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:10.011713 [ 48 ] {7183fd60-b861-41bc-a1c9-3777a443e157} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_district_code) is found inside another aggregate function in query: While processing topK(1)(customer_district_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(customer_district_code), countIf(customer_district_code IS NULL), topK(1)(customer_district_code)[1] AS most_freq, countIf(customer_district_code = topK(1)(customer_district_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:10.012099 [ 48 ] {7183fd60-b861-41bc-a1c9-3777a443e157} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_district_code) is found inside another aggregate function in query: While processing topK(1)(customer_district_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:10.013736 [ 48 ] {fdbf652c-3a46-4ca1-a13f-4a01d26f627b} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_region_code) is found inside another aggregate function in query: While processing topK(1)(customer_region_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(customer_region_code), countIf(customer_region_code IS NULL), topK(1)(customer_region_code)[1] AS most_freq, countIf(customer_region_code = topK(1)(customer_region_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:10.014094 [ 48 ] {fdbf652c-3a46-4ca1-a13f-4a01d26f627b} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_region_code) is found inside another aggregate function in query: While processing topK(1)(customer_region_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 04:39:10.086558 [ 48 ] {952bb04a-263f-4191-b1a8-a97194f866e1} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(installment_status) is found inside another aggregate function in query: While processing topK(1)(installment_status). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:45562) (in query:  SELECT uniqExact(installment_status), countIf(installment_status IS NULL), topK(1)(installment_status)[1] AS most_freq, countIf(installment_status = topK(1)(installment_status)[1]) FROM stg_bank001_retail_payments FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 04:39:10.086821 [ 48 ] {952bb04a-263f-4191-b1a8-a97194f866e1} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(installment_status) is found inside another aggregate function in query: While processing topK(1)(installment_status). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.226416 [ 48 ] {e5b485a5-0d9c-4ff7-b56b-78cb466fe0c6} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_type) is found inside another aggregate function in query: While processing topK(1)(customer_type). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(customer_type), countIf(customer_type IS NULL), topK(1)(customer_type)[1] AS most_freq, countIf(customer_type = topK(1)(customer_type)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.227121 [ 48 ] {e5b485a5-0d9c-4ff7-b56b-78cb466fe0c6} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_type) is found inside another aggregate function in query: While processing topK(1)(customer_type). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.229028 [ 48 ] {99be15b3-e0c1-45a9-a71a-0855227d1e5f} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_product_type) is found inside another aggregate function in query: While processing topK(1)(loan_product_type). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(loan_product_type), countIf(loan_product_type IS NULL), topK(1)(loan_product_type)[1] AS most_freq, countIf(loan_product_type = topK(1)(loan_product_type)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.229352 [ 48 ] {99be15b3-e0c1-45a9-a71a-0855227d1e5f} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_product_type) is found inside another aggregate function in query: While processing topK(1)(loan_product_type). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.230917 [ 48 ] {6b00d7bf-7dd2-4886-8163-a26167985106} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_code) is found inside another aggregate function in query: While processing topK(1)(loan_status_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(loan_status_code), countIf(loan_status_code IS NULL), topK(1)(loan_status_code)[1] AS most_freq, countIf(loan_status_code = topK(1)(loan_status_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.231240 [ 48 ] {6b00d7bf-7dd2-4886-8163-a26167985106} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_code) is found inside another aggregate function in query: While processing topK(1)(loan_status_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.232565 [ 48 ] {b16fbf61-2a66-4b8b-ae24-c35b929d5ad5} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_flag) is found inside another aggregate function in query: While processing topK(1)(loan_status_flag). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(loan_status_flag), countIf(loan_status_flag IS NULL), topK(1)(loan_status_flag)[1] AS most_freq, countIf(loan_status_flag = topK(1)(loan_status_flag)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.232901 [ 48 ] {b16fbf61-2a66-4b8b-ae24-c35b929d5ad5} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_flag) is found inside another aggregate function in query: While processing topK(1)(loan_status_flag). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.234328 [ 48 ] {9dce6061-77f9-45cb-9884-b46b7035509f} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(insurance_included) is found inside another aggregate function in query: While processing topK(1)(insurance_included). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(insurance_included), countIf(insurance_included IS NULL), topK(1)(insurance_included)[1] AS most_freq, countIf(insurance_included = topK(1)(insurance_included)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.234634 [ 48 ] {9dce6061-77f9-45cb-9884-b46b7035509f} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(insurance_included) is found inside another aggregate function in query: While processing topK(1)(insurance_included). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.236106 [ 48 ] {7eb3ff66-85ab-4636-a232-9dd8a66d2cf2} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(sector_code) is found inside another aggregate function in query: While processing topK(1)(sector_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(sector_code), countIf(sector_code IS NULL), topK(1)(sector_code)[1] AS most_freq, countIf(sector_code = topK(1)(sector_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.236447 [ 48 ] {7eb3ff66-85ab-4636-a232-9dd8a66d2cf2} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(sector_code) is found inside another aggregate function in query: While processing topK(1)(sector_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.237908 [ 48 ] {83e4a37d-e901-4fb2-9aed-ed7c3d2acd38} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_segment) is found inside another aggregate function in query: While processing topK(1)(customer_segment). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(customer_segment), countIf(customer_segment IS NULL), topK(1)(customer_segment)[1] AS most_freq, countIf(customer_segment = topK(1)(customer_segment)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.238299 [ 48 ] {83e4a37d-e901-4fb2-9aed-ed7c3d2acd38} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_segment) is found inside another aggregate function in query: While processing topK(1)(customer_segment). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.239721 [ 48 ] {95b1efce-0c0c-4697-8c22-e5174049832a} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(risk_class) is found inside another aggregate function in query: While processing topK(1)(risk_class). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(risk_class), countIf(risk_class IS NULL), topK(1)(risk_class)[1] AS most_freq, countIf(risk_class = topK(1)(risk_class)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.240118 [ 48 ] {95b1efce-0c0c-4697-8c22-e5174049832a} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(risk_class) is found inside another aggregate function in query: While processing topK(1)(risk_class). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.314087 [ 48 ] {e513e505-1ac4-4068-a4c2-15a232639362} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(internal_rating) is found inside another aggregate function in query: While processing topK(1)(internal_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(internal_rating), countIf(internal_rating IS NULL), topK(1)(internal_rating)[1] AS most_freq, countIf(internal_rating = topK(1)(internal_rating)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.314263 [ 48 ] {e513e505-1ac4-4068-a4c2-15a232639362} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(internal_rating) is found inside another aggregate function in query: While processing topK(1)(internal_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.315489 [ 48 ] {65430d80-994a-4ef8-bc18-9521564bc720} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(internal_credit_rating) is found inside another aggregate function in query: While processing topK(1)(internal_credit_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(internal_credit_rating), countIf(internal_credit_rating IS NULL), topK(1)(internal_credit_rating)[1] AS most_freq, countIf(internal_credit_rating = topK(1)(internal_credit_rating)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.315672 [ 48 ] {65430d80-994a-4ef8-bc18-9521564bc720} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(internal_credit_rating) is found inside another aggregate function in query: While processing topK(1)(internal_credit_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.316890 [ 48 ] {dfdf1133-5b2a-495d-a481-7a65df8a8d53} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(external_rating) is found inside another aggregate function in query: While processing topK(1)(external_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(external_rating), countIf(external_rating IS NULL), topK(1)(external_rating)[1] AS most_freq, countIf(external_rating = topK(1)(external_rating)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.317092 [ 48 ] {dfdf1133-5b2a-495d-a481-7a65df8a8d53} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(external_rating) is found inside another aggregate function in query: While processing topK(1)(external_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.318450 [ 48 ] {bbfbd3a4-95d4-4688-96d9-7e61643b9ce0} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_province_code) is found inside another aggregate function in query: While processing topK(1)(customer_province_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(customer_province_code), countIf(customer_province_code IS NULL), topK(1)(customer_province_code)[1] AS most_freq, countIf(customer_province_code = topK(1)(customer_province_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.318663 [ 48 ] {bbfbd3a4-95d4-4688-96d9-7e61643b9ce0} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_province_code) is found inside another aggregate function in query: While processing topK(1)(customer_province_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.320135 [ 48 ] {51c48076-3b35-4c05-bb34-0e01d09bfebf} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_district_code) is found inside another aggregate function in query: While processing topK(1)(customer_district_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(customer_district_code), countIf(customer_district_code IS NULL), topK(1)(customer_district_code)[1] AS most_freq, countIf(customer_district_code = topK(1)(customer_district_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.320347 [ 48 ] {51c48076-3b35-4c05-bb34-0e01d09bfebf} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_district_code) is found inside another aggregate function in query: While processing topK(1)(customer_district_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.321585 [ 48 ] {89369e8c-402d-4f04-bb70-f4e71a05c34e} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_region_code) is found inside another aggregate function in query: While processing topK(1)(customer_region_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(customer_region_code), countIf(customer_region_code IS NULL), topK(1)(customer_region_code)[1] AS most_freq, countIf(customer_region_code = topK(1)(customer_region_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.321750 [ 48 ] {89369e8c-402d-4f04-bb70-f4e71a05c34e} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_region_code) is found inside another aggregate function in query: While processing topK(1)(customer_region_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:05:19.417221 [ 48 ] {32217c19-a90b-48a0-afc4-cca4ef67a88e} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(installment_status) is found inside another aggregate function in query: While processing topK(1)(installment_status). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49820) (in query:  SELECT uniqExact(installment_status), countIf(installment_status IS NULL), topK(1)(installment_status)[1] AS most_freq, countIf(installment_status = topK(1)(installment_status)[1]) FROM stg_bank001_retail_payments FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:05:19.417511 [ 48 ] {32217c19-a90b-48a0-afc4-cca4ef67a88e} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(installment_status) is found inside another aggregate function in query: While processing topK(1)(installment_status). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.493924 [ 48 ] {0d025c76-421b-41a2-8b56-04495d91c4fc} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_type) is found inside another aggregate function in query: While processing topK(1)(customer_type). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(customer_type), countIf(customer_type IS NULL), topK(1)(customer_type)[1] AS most_freq, countIf(customer_type = topK(1)(customer_type)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.494396 [ 48 ] {0d025c76-421b-41a2-8b56-04495d91c4fc} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_type) is found inside another aggregate function in query: While processing topK(1)(customer_type). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.495946 [ 48 ] {af99b92d-c963-4a83-891d-07bec0a4fc4e} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_product_type) is found inside another aggregate function in query: While processing topK(1)(loan_product_type). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(loan_product_type), countIf(loan_product_type IS NULL), topK(1)(loan_product_type)[1] AS most_freq, countIf(loan_product_type = topK(1)(loan_product_type)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.496269 [ 48 ] {af99b92d-c963-4a83-891d-07bec0a4fc4e} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_product_type) is found inside another aggregate function in query: While processing topK(1)(loan_product_type). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.497993 [ 48 ] {643b6d1d-ff89-4647-a081-ccf1342a0267} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_code) is found inside another aggregate function in query: While processing topK(1)(loan_status_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(loan_status_code), countIf(loan_status_code IS NULL), topK(1)(loan_status_code)[1] AS most_freq, countIf(loan_status_code = topK(1)(loan_status_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.498314 [ 48 ] {643b6d1d-ff89-4647-a081-ccf1342a0267} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_code) is found inside another aggregate function in query: While processing topK(1)(loan_status_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.500001 [ 48 ] {5a790812-50bd-40ca-927f-7bae712166c3} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_flag) is found inside another aggregate function in query: While processing topK(1)(loan_status_flag). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(loan_status_flag), countIf(loan_status_flag IS NULL), topK(1)(loan_status_flag)[1] AS most_freq, countIf(loan_status_flag = topK(1)(loan_status_flag)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.500290 [ 48 ] {5a790812-50bd-40ca-927f-7bae712166c3} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(loan_status_flag) is found inside another aggregate function in query: While processing topK(1)(loan_status_flag). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.501926 [ 48 ] {c98be69f-f64e-4aa7-9020-759d242c5384} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(insurance_included) is found inside another aggregate function in query: While processing topK(1)(insurance_included). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(insurance_included), countIf(insurance_included IS NULL), topK(1)(insurance_included)[1] AS most_freq, countIf(insurance_included = topK(1)(insurance_included)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.502215 [ 48 ] {c98be69f-f64e-4aa7-9020-759d242c5384} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(insurance_included) is found inside another aggregate function in query: While processing topK(1)(insurance_included). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.503665 [ 48 ] {a88405c5-f884-46c8-bc41-f61013ed9f47} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(sector_code) is found inside another aggregate function in query: While processing topK(1)(sector_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(sector_code), countIf(sector_code IS NULL), topK(1)(sector_code)[1] AS most_freq, countIf(sector_code = topK(1)(sector_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.503950 [ 48 ] {a88405c5-f884-46c8-bc41-f61013ed9f47} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(sector_code) is found inside another aggregate function in query: While processing topK(1)(sector_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.505417 [ 48 ] {89993e50-aab4-4035-a887-803a1dcedcee} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_segment) is found inside another aggregate function in query: While processing topK(1)(customer_segment). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(customer_segment), countIf(customer_segment IS NULL), topK(1)(customer_segment)[1] AS most_freq, countIf(customer_segment = topK(1)(customer_segment)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.505857 [ 48 ] {89993e50-aab4-4035-a887-803a1dcedcee} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_segment) is found inside another aggregate function in query: While processing topK(1)(customer_segment). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.507436 [ 48 ] {fb7e5790-a1dd-4e99-90fd-e9f8357679ef} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(risk_class) is found inside another aggregate function in query: While processing topK(1)(risk_class). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(risk_class), countIf(risk_class IS NULL), topK(1)(risk_class)[1] AS most_freq, countIf(risk_class = topK(1)(risk_class)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.507762 [ 48 ] {fb7e5790-a1dd-4e99-90fd-e9f8357679ef} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(risk_class) is found inside another aggregate function in query: While processing topK(1)(risk_class). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.570119 [ 48 ] {14e0a4cb-c434-4e1e-a720-c319df8bc72f} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(internal_rating) is found inside another aggregate function in query: While processing topK(1)(internal_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(internal_rating), countIf(internal_rating IS NULL), topK(1)(internal_rating)[1] AS most_freq, countIf(internal_rating = topK(1)(internal_rating)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.570626 [ 48 ] {14e0a4cb-c434-4e1e-a720-c319df8bc72f} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(internal_rating) is found inside another aggregate function in query: While processing topK(1)(internal_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.572692 [ 48 ] {6689fd40-08d7-4719-a69d-fd8ee4186947} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(internal_credit_rating) is found inside another aggregate function in query: While processing topK(1)(internal_credit_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(internal_credit_rating), countIf(internal_credit_rating IS NULL), topK(1)(internal_credit_rating)[1] AS most_freq, countIf(internal_credit_rating = topK(1)(internal_credit_rating)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.573128 [ 48 ] {6689fd40-08d7-4719-a69d-fd8ee4186947} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(internal_credit_rating) is found inside another aggregate function in query: While processing topK(1)(internal_credit_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.575002 [ 48 ] {e89dc50e-0552-4ec0-ad32-6fe51372e80e} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(external_rating) is found inside another aggregate function in query: While processing topK(1)(external_rating). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(external_rating), countIf(external_rating IS NULL), topK(1)(external_rating)[1] AS most_freq, countIf(external_rating = topK(1)(external_rating)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.575389 [ 48 ] {e89dc50e-0552-4ec0-ad32-6fe51372e80e} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(external_rating) is found inside another aggregate function in query: While processing topK(1)(external_rating). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.577065 [ 48 ] {4c965f57-e207-48be-acb3-44661c386307} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_province_code) is found inside another aggregate function in query: While processing topK(1)(customer_province_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(customer_province_code), countIf(customer_province_code IS NULL), topK(1)(customer_province_code)[1] AS most_freq, countIf(customer_province_code = topK(1)(customer_province_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.577414 [ 48 ] {4c965f57-e207-48be-acb3-44661c386307} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_province_code) is found inside another aggregate function in query: While processing topK(1)(customer_province_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.579191 [ 48 ] {b175c33e-86ad-4088-b1ee-26931035ba0b} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_district_code) is found inside another aggregate function in query: While processing topK(1)(customer_district_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(customer_district_code), countIf(customer_district_code IS NULL), topK(1)(customer_district_code)[1] AS most_freq, countIf(customer_district_code = topK(1)(customer_district_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.579556 [ 48 ] {b175c33e-86ad-4088-b1ee-26931035ba0b} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_district_code) is found inside another aggregate function in query: While processing topK(1)(customer_district_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.581099 [ 48 ] {2af4dfd8-5248-4cda-889d-349bb6ca35ed} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(customer_region_code) is found inside another aggregate function in query: While processing topK(1)(customer_region_code). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(customer_region_code), countIf(customer_region_code IS NULL), topK(1)(customer_region_code)[1] AS most_freq, countIf(customer_region_code = topK(1)(customer_region_code)[1]) FROM stg_bank001_retail_credits FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.581434 [ 48 ] {2af4dfd8-5248-4cda-889d-349bb6ca35ed} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(customer_region_code) is found inside another aggregate function in query: While processing topK(1)(customer_region_code). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:06:37.678203 [ 48 ] {64aab238-d1ee-4235-8c77-c3f4b0c2d03b} <Error> executeQuery: Code: 184. DB::Exception: Aggregate function topK(1)(installment_status) is found inside another aggregate function in query: While processing topK(1)(installment_status). (ILLEGAL_AGGREGATION) (version 23.8.16.16 (official build)) (from 172.18.0.8:49028) (in query:  SELECT uniqExact(installment_status), countIf(installment_status IS NULL), topK(1)(installment_status)[1] AS most_freq, countIf(installment_status = topK(1)(installment_status)[1]) FROM stg_bank001_retail_payments FORMAT Native), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6

2026.02.07 05:06:37.678554 [ 48 ] {64aab238-d1ee-4235-8c77-c3f4b0c2d03b} <Error> DynamicQueryHandler: Code: 184. DB::Exception: Aggregate function topK(1)(installment_status) is found inside another aggregate function in query: While processing topK(1)(installment_status). (ILLEGAL_AGGREGATION), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bfc4824 in /usr/bin/clickhouse
1. DB::Exception::Exception<String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&) @ 0x00000000075d2c4c in /usr/bin/clickhouse
2. DB::GetAggregatesMatcher::visit(DB::ASTFunction const&, std::shared_ptr<DB::IAST> const&, DB::GetAggregatesMatcher::Data&) @ 0x0000000010b1555c in /usr/bin/clickhouse
3. DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::doVisit(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15240 in /usr/bin/clickhouse
4. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a3c in /usr/bin/clickhouse
5. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
6. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
7. void DB::InDepthNodeVisitor<DB::GetAggregatesMatcher, true, false, std::shared_ptr<DB::IAST> const>::visitChildren<false>(std::shared_ptr<DB::IAST> const&) @ 0x0000000010b15a48 in /usr/bin/clickhouse
8. DB::(anonymous namespace)::getAggregates(std::shared_ptr<DB::IAST>&, DB::ASTSelectQuery const&) @ 0x0000000011438020 in /usr/bin/clickhouse
9. DB::TreeRewriter::analyzeSelect(std::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::vector<DB::TableWithColumnNamesAndTypes, std::allocator<DB::TableWithColumnNamesAndTypes>> const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::TableJoin>) const @ 0x00000000114355d8 in /usr/bin/clickhouse
10. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>)::$_0::operator()(bool) const @ 0x000000001114adac in /usr/bin/clickhouse
11. DB::InterpreterSelectQuery::InterpreterSelectQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context> const&, std::optional<DB::Pipe>, std::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::shared_ptr<DB::PreparedSets>) @ 0x0000000011145788 in /usr/bin/clickhouse
12. DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::shared_ptr<DB::IAST> const&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::vector<String, std::allocator<String>> const&) @ 0x00000000111d89e8 in /usr/bin/clickhouse
13. DB::InterpreterFactory::get(std::shared_ptr<DB::IAST>&, std::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) @ 0x0000000011104f04 in /usr/bin/clickhouse
14. DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x00000000114c9244 in /usr/bin/clickhouse
15. DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, std::shared_ptr<DB::Context>, std::function<void (DB::QueryResultDetails const&)>, std::optional<DB::FormatSettings> const&, std::function<void (DB::IOutputFormat&)>) @ 0x00000000114cc29c in /usr/bin/clickhouse
16. DB::HTTPHandler::processQuery(DB::HTTPServerRequest&, DB::HTMLForm&, DB::HTTPServerResponse&, DB::HTTPHandler::Output&, std::optional<DB::CurrentThread::QueryScope>&) @ 0x000000001216e22c in /usr/bin/clickhouse
17. DB::HTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&) @ 0x0000000012171db0 in /usr/bin/clickhouse
18. DB::HTTPServerConnection::run() @ 0x00000000121d456c in /usr/bin/clickhouse
19. Poco::Net::TCPServerConnection::start() @ 0x00000000146da6e4 in /usr/bin/clickhouse
20. Poco::Net::TCPServerDispatcher::run() @ 0x00000000146dbbe0 in /usr/bin/clickhouse
21. Poco::PooledThread::run() @ 0x000000001484ed5c in /usr/bin/clickhouse
22. Poco::ThreadImpl::runnableEntry(void*) @ 0x000000001484cf04 in /usr/bin/clickhouse
23. start_thread @ 0x0000000000007624 in /lib/libpthread.so.0
24. ? @ 0x00000000000d162c in /lib/libc.so.6
 (version 23.8.16.16 (official build))
2026.02.07 05:10:18.630177 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 05:10:18.659772 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 05:10:18.949891 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 05:10:19.943882 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 05:10:19.952413 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 05:10:19.960851 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 05:10:19.969816 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:00:38.709808 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 09:00:38.751831 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 09:00:39.173756 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:00:39.646361 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:00:39.655163 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:00:39.663807 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:00:39.673364 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:06:13.266645 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 09:06:13.281242 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 09:06:13.425925 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:06:14.096691 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:06:14.105280 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:06:14.129408 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:06:14.146228 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:18:35.198949 [ 1 ] {} <Warning> Application: Closed all listening sockets. Waiting for 1 outstanding connections.
2026.02.07 09:19:03.715814 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 09:19:03.734451 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 09:19:03.931173 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:19:04.374109 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:19:04.384338 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:19:04.403347 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:19:04.423331 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:44:50.225847 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 09:44:50.248189 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 09:44:50.390254 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:44:50.978227 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:44:50.988151 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:44:50.997261 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:44:51.013271 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:51:28.909048 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 09:51:28.919612 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 09:51:29.076740 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:51:29.238920 [ 299 ] {} <Warning> system.metric_log (0c40b3c1-cf60-4dff-954d-18438a8ea2e5): Removing temporary directory /var/lib/clickhouse/store/0c4/0c40b3c1-cf60-4dff-954d-18438a8ea2e5/tmp_insert_202602_50_50_0/
2026.02.07 09:51:29.552646 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:51:29.564088 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:51:29.573566 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:51:29.582164 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:59:12.192842 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 09:59:12.199835 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 09:59:12.511887 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:59:13.258696 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:59:13.267506 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:59:13.277087 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 09:59:13.286510 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 10:59:55.712020 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 10:59:55.730163 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 10:59:55.885707 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 10:59:56.303794 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 10:59:56.313053 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 10:59:56.322491 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 10:59:56.331018 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 11:37:39.017294 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 11:37:39.039779 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 11:37:39.371395 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 11:37:40.440808 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 11:37:40.471737 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 11:37:40.483246 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 11:37:40.493389 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 14:09:04.973123 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 14:09:05.011800 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 14:09:05.291393 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 14:09:05.796740 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 14:09:05.804861 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 14:09:05.813865 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 14:09:05.823119 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 16:28:01.925180 [ 1 ] {} <Warning> Context: Linux transparent hugepages are set to "always". Check /sys/kernel/mm/transparent_hugepage/enabled
2026.02.07 16:28:01.959338 [ 1 ] {} <Warning> Application: Integrity check of the executable skipped because the reference checksum could not be read.
2026.02.07 16:28:02.445962 [ 1 ] {} <Warning> Application: Listen [::]:9009 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 16:28:03.416016 [ 1 ] {} <Warning> Application: Listen [::]:8123 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 16:28:03.426537 [ 1 ] {} <Warning> Application: Listen [::]:9000 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 16:28:03.435617 [ 1 ] {} <Warning> Application: Listen [::]:9004 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
2026.02.07 16:28:03.445284 [ 1 ] {} <Warning> Application: Listen [::]:9005 failed: Poco::Exception. Code: 1000, e.code() = 0, DNS error: EAI: Address family for hostname not supported (version 23.8.16.16 (official build)). If it is an IPv6 or IPv4 address and your host has disabled IPv6 or IPv4, then consider to specify not disabled IPv4 or IPv6 address to listen in <listen_host> element of configuration file. Example for disabled IPv6: <listen_host>0.0.0.0</listen_host> . Example for disabled IPv4: <listen_host>::</listen_host>
